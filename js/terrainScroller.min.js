/**
 * Created by Jussi Parviainen
*/
"use strict";function MountainScrollEffect(e,h=!0){this.canvas=e,this.resizeCanvas=h,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(60,this.canvas.width/this.canvas.height,.1,1e3),this.camera.position.x=128,this.camera.position.y=10,this.camera.position.z=20,this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.canvas.width,this.canvas.height),this.cameraSpeed=5,this.chunkManager=new ChunkManager;e=new THREE.BoxGeometry(5,5,5),h=new THREE.MeshPhongMaterial({color:15790320}),e=new THREE.Mesh(e,h),this.scene.add(e),h=new THREE.DirectionalLight(16777215,2);h.position.set(-1,1e3,3e3),this.scene.add(h),this.scene.fog=new THREE.Fog(0,100,500),this.prevChunkID=this.chunkManager.CalculateChunkIndex(this.camera.position.x,this.camera.position.z),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x,this.prevChunkID.z)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x-1,this.prevChunkID.z)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x-2,this.prevChunkID.z)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x+1,this.prevChunkID.z)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x+2,this.prevChunkID.z)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x,this.prevChunkID.z-1)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x-1,this.prevChunkID.z-1)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x-2,this.prevChunkID.z-1)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x+1,this.prevChunkID.z-1)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x+2,this.prevChunkID.z-1)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x,this.prevChunkID.z-2)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x-1,this.prevChunkID.z-2)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x-2,this.prevChunkID.z-2)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x+1,this.prevChunkID.z-2)),this.scene.add(this.chunkManager.GenerateChunk(this.prevChunkID.x+2,this.prevChunkID.z-2)),this.MAX_GEN_COUNT_PER_FRAME=1,this.generationQueue=[],this.removeQueue=[],this._prevTime=0,this.delta=0,this.ResizeCanvas=function(){this.renderer.width===window.innerWidth&&this.renderer.height===window.innerHeight||(this.renderer.setSize(window.innerWidth,window.innerHeight),this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix())},this.Update=function(e){if(requestAnimationFrame(this.Update.bind(this)),!0===this.resizeCanvas&&this.ResizeCanvas(),this.delta=.01*(e-this._prevTime),this._prevTime=e,!(this.delta<=1e-6||.2<=this.delta)){this.camera.position.z-=this.cameraSpeed*this.delta,this.camera.position.y=this.chunkManager.GetMaxHeight()+10;for(var h,e=this.chunkManager.CalculateChunkIndex(this.camera.position.x,this.camera.position.z),t=(e.x===this.prevChunkID.x&&e.z===this.prevChunkID.z||(null!==(h=this.chunkManager.GetChunk(this.prevChunkID.x,this.prevChunkID.z))&&(this.scene.remove(h),this.chunkManager.RemoveChunk(this.prevChunkID.x,this.prevChunkID.z)),null!==(h=this.chunkManager.GetChunk(this.prevChunkID.x-1,this.prevChunkID.z))&&(this.scene.remove(h),this.chunkManager.RemoveChunk(this.prevChunkID.x-1,this.prevChunkID.z)),null!==(h=this.chunkManager.GetChunk(this.prevChunkID.x-2,this.prevChunkID.z))&&(this.scene.remove(h),this.chunkManager.RemoveChunk(this.prevChunkID.x-2,this.prevChunkID.z)),null!==(h=this.chunkManager.GetChunk(this.prevChunkID.x+1,this.prevChunkID.z))&&(this.scene.remove(h),this.chunkManager.RemoveChunk(this.prevChunkID.x+1,this.prevChunkID.z)),null!==(h=this.chunkManager.GetChunk(this.prevChunkID.x+2,this.prevChunkID.z))&&(this.scene.remove(h),this.chunkManager.RemoveChunk(this.prevChunkID.x+2,this.prevChunkID.z)),this.generationQueue.push({x:e.x,z:e.z-2}),this.generationQueue.push({x:e.x+1,z:e.z-2}),this.generationQueue.push({x:e.x+2,z:e.z-2}),this.generationQueue.push({x:e.x-1,z:e.z-2}),this.generationQueue.push({x:e.x-2,z:e.z-2})),0);t<this.MAX_GEN_COUNT_PER_FRAME&&0<this.generationQueue.length;){var i=this.generationQueue.pop();this.scene.add(this.chunkManager.GenerateChunk(i.x,i.z)),t++}this.prevChunkID=e,this.renderer.render(this.scene,this.camera)}},this.Update(0)}function Noise(e,h=0,t=4,i=.004,s=2,n=.5,a=0,u=0){this.simplex=new Simplex(e),this.type=h,this.octaves=t,this.frequency=i,this.lacunarity=s,this.persistence=n,this.offsetX=a,this.offsetZ=u,this.Evaluate=function(e,h){return this.simplex.FBM(e,0,h,this.octaves,this.frequency,this.lacunarity,this.persistence,this.offsetX,0,this.offsetZ,this.type)}}function GradientNoise(e=[]){this.keys=e,this.AddKey=function(e,h){for(var t={time:e,noise:h},i=0;i<this.keys.length;){if(!(i+1<this.keys.length)){this.keys.push(t);break}if(e>=this.keys[i].time&&e<this.keys[i+1].time){this.keys.splice(i,0,t);break}i++}},this.Evaluate=function(e,h,t){for(var i,s,n=0;n<this.keys.length;){if(!(n+1<this.keys.length))return this.keys[n].noise.Evaluate(e,h);if(t>=this.keys[n].time&&t<this.keys[n+1].time)return i=this.keys[n].noise.Evaluate(e,h),s=this.keys[n+1].noise.Evaluate(e,h),i+(t-this.keys[n].time)/(this.keys[n+1].time-this.keys[n].time)*(s-i);n++}return 0}}function ChunkManager(e=Math.floor(9999999*Math.random())){this.chunkSizeX=64,this.chunkSizeZ=64,this.chunkVertexGap=4,this.gradientNoise=new GradientNoise([{time:0,noise:new Noise(e-942,0,4,.001,2,.5,0,0)},{time:.2,noise:new Noise(e-942,0,4,.001,2,.5,0,0)},{time:.3,noise:new Noise(e+2921,1,2,.002,2,.5,0,0)},{time:.7,noise:new Noise(e+2921,1,2,.002,2,.5,0,0)},{time:.8,noise:new Noise(e-2428,2,4,.001,2,.5,0,0)},{time:1,noise:new Noise(e-2428,2,4,.001,2,.5,0,0)}]),this.baseNoise=new Noise(e+828,0,4,.02,2,.5,0,0),this.mountainMask=new Noise(e-7427,0,0,.004,2,.5,0,0),this.moutainTypeMask=new Noise(e-1284,0,0,.002,2,.5,0,0),this.mountainTreshold=.2,this.baseHeight=10,this.mountainHeight=70,this.chunks=[],this.GetHeight=function(e,h){var t=this.baseNoise.Evaluate(e,h)*this.baseHeight,i=this.mountainMask.Evaluate(e,h);return i<this.mountainTreshold?t:(i=(i-this.mountainTreshold)/(1-this.mountainTreshold),t+this.gradientNoise.Evaluate(e,h,this.moutainTypeMask.Evaluate(e,h))*this.mountainHeight*i)},this.GetMaxHeight=function(){return this.baseHeight+this.mountainHeight},this.GenerateChunk=function(e,h){var t=e+"_"+h;if(void 0===this.chunks[t]||null===this.chunks[t]){for(var i,s,n,a,u,r,k,o,c=e*this.chunkSizeX*this.chunkVertexGap,p=h*this.chunkSizeZ*this.chunkVertexGap,e=new THREE.BufferGeometry,v=[],C=0,d=0;C<this.chunkSizeX;){for(d=0,s=(i=C*this.chunkVertexGap)+this.chunkVertexGap,u=this.GetHeight(c+i,p),r=this.GetHeight(c+s,p);d<this.chunkSizeZ;)a=(n=d*this.chunkVertexGap)+this.chunkVertexGap,k=this.GetHeight(c+i,p+a),o=this.GetHeight(c+s,p+a),v.push(i),v.push(u),v.push(n),v.push(i),v.push(k),v.push(a),v.push(s),v.push(r),v.push(n),v.push(i),v.push(k),v.push(a),v.push(s),v.push(o),v.push(a),v.push(s),v.push(r),v.push(n),u=k,r=o,d++;C++}e.setAttribute("position",new THREE.BufferAttribute(new Float32Array(v),3));h=new THREE.MeshBasicMaterial({color:16711935,wireframe:!0}),e=new THREE.Mesh(e,h);return e.position.x=c,e.position.y=0,e.position.z=p,this.chunks[t]=e}},this.AddChunk=function(e,h){this.chunks[e+"_"+h]=new Chunk(e,h)},this.RemoveChunk=function(e,h){e=e+"_"+h;void 0!==this.chunks[e]&&null!==this.chunks[e]&&(this.chunks[e].geometry.dispose(),this.chunks[e].material.dispose(),delete this.chunks[e])},this.GetChunk=function(e,h){e=e+"_"+h;return void 0!==this.chunks[e]||null!==this.chunks[e]?this.chunks[e]:null},this.CalculateChunkIndex=function(e,h){return{x:Math.floor(e/(this.chunkSizeX*this.chunkVertexGap)),z:Math.floor(h/(this.chunkSizeZ*this.chunkVertexGap))}}}window.onload=function(){new MountainScrollEffect(document.getElementById("BackgroundCanvas"))};